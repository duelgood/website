FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        postfix opendkim opendkim-tools ca-certificates rsyslog netcat-openbsd && \
    rm -rf /var/lib/apt/lists/*

# Copy configurations
COPY postfix/main.cf /etc/postfix/main.cf
COPY postfix/master.cf /etc/postfix/master.cf
COPY opendkim/opendkim.conf /etc/opendkim.conf
COPY opendkim/default /etc/default/opendkim
COPY entrypoint.sh /entrypoint.sh

RUN mkdir -p /etc/opendkim/keys/duelgood.org /var/spool/postfix && \
    chown -R opendkim:opendkim /etc/opendkim && \
    chmod 700 /etc/opendkim/keys && \
    chmod +x /entrypoint.sh && \
    chown -R postfix:postfix /var/spool/postfix && \
    echo "duelgood.org" > /etc/mailname && \
    echo "127.0.0.1 mail.duelgood.org duelgood.org" >> /etc/hosts && \
    chown root:root /var/spool/postfix && chmod 755 /var/spool/postfix && \
    chown root:root /var/spool/postfix/pid && chmod 755 /var/spool/postfix/pid && \
    chown root:postdrop /var/spool/postfix/public && chmod 710 /var/spool/postfix/public && \
    chown root:postfix /var/spool/postfix/maildrop && chmod 730 /var/spool/postfix/maildrop && \
    chown root:root /var/spool/postfix/etc && chmod 755 /var/spool/postfix/etc && \
    chown root:root /var/spool/postfix/lib && chmod 755 /var/spool/postfix/lib && \
    chown root:root /var/spool/postfix/usr && chmod 755 /var/spool/postfix/usr && \
    mkdir -p /var/spool/postfix/opendkim && chown opendkim:postfix /var/spool/postfix/opendkim && chmod 750 /var/spool/postfix/opendkim

EXPOSE 25

ENTRYPOINT ["/entrypoint.sh"]
